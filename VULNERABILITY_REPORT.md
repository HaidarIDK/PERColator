# Percolator Vulnerability Analysis Report

## Executive Summary

This report analyzes potential vulnerabilities in the Percolator Solana-based perpetual DEX, assuming documentation and comments may be inaccurate. The analysis focuses on common DeFi vulnerabilities in perpetual exchanges, including loss socialization, liquidation, order matching, and oracle manipulation risks.

**Overall Assessment:** The codebase heavily relies on formal verification (Kani proofs) for critical components, but several implementation issues remain that could lead to fund loss or unfair outcomes.

## Critical Vulnerabilities

### 1. Slab Whitelist Bypass (High Severity)
**Location:** `programs/router/src/instructions/execute_cross_slab.rs`

**Description:**
The `execute_cross_slab` instruction allows users to execute trades across multiple slabs without verifying that the slabs are registered in the `SlabRegistry`. While slab registration is governance-controlled, execution does not check registry membership.

**Impact:**
- Users could execute trades on unauthorized or malicious slabs
- Potential fund loss if interacting with compromised order books
- Bypasses governance controls on allowed trading venues

**Exploit Scenario:**
An attacker creates a fake slab program and tricks users into including it in their `slab_accounts` array, potentially stealing fees or manipulating fills.

**Recommendation:**
Add registry validation in `execute_cross_slab` to ensure all slabs in `slab_accounts` are registered and active.

### 2. Oracle Staleness Vulnerability (Medium-High Severity)
**Location:** `programs/oracle/src/state.rs`, price usage throughout system

**Description:**
The oracle program has no staleness checks. Prices can be arbitrarily old, and the system uses them without timestamp validation.

**Impact:**
- Liquidations could occur at stale prices
- Orders filled at incorrect market rates
- Funding rates calculated with outdated data

**Exploit Scenario:**
Oracle authority stops updating prices. During a volatile market period, stale prices could trigger incorrect liquidations or allow trading at unfair rates.

**Recommendation:**
Implement staleness checks in price reading functions, rejecting prices older than a configurable threshold (e.g., 60 seconds).

## Medium Vulnerabilities

### 3. Vesting Truncation Bug (Medium Severity)
**Location:** `crates/model_safety/src/crisis/materialize.rs:157-165`

**Description:**
Linear vesting calculation uses integer division that truncates small amounts to zero:

```rust
let vested = (u.warming * f_num) / f_den;
```

For small `u.warming` values relative to `tau_slots`, vesting never occurs.

**Impact:**
- Users with small warming PnL balances cannot access their funds
- Unfair treatment of small traders vs large traders
- Potential locked funds

**Exploit Scenario:**
A trader realizes small profits that accumulate in warming PnL but never vest due to truncation, effectively locking those funds.

**Recommendation:**
Use fixed-point arithmetic for vesting calculations to handle fractional amounts properly.

### 4. Arithmetic Precision Loss in Crisis Haircuts (Medium Severity)
**Location:** `crates/model_safety/src/crisis/haircut.rs:115-125`

**Description:**
While the crisis module uses `Q64x64` fixed-point for scales, the aggregate updates use integer division which may lose precision:

```rust
let new_principal = one_minus_rho.mul_i128(a.sigma_principal);
```

If `mul_i128` clamps results, precision could be lost for large aggregates.

**Impact:**
- Slightly unfair loss distribution during insolvency events
- Small rounding errors accumulate across users

**Recommendation:**
Verify that `Q64x64::mul_i128` handles large values without excessive clamping.

## Low-Medium Vulnerabilities

### 5. Panic-Prone Unwrap Usage (Low-Medium Severity)
**Location:** Multiple files (grep for "unwrap")

**Description:**
Several production files use `unwrap()` which can cause program panics on Solana, potentially freezing user funds.

**Examples:**
- `programs/slab/src/instructions/place_order.rs`: Clock sysvar access
- Various state deserialization calls

**Impact:**
- Transaction failures could leave users in inconsistent states
- Potential for DoS if sysvar access fails

**Recommendation:**
Replace `unwrap()` with proper error handling and return `Result` types.

### 6. TOCTOU in Order Matching (Low Severity)
**Location:** `programs/slab/src/instructions/commit_fill.rs:32-36`

**Description:**
While seqno validation exists, the check occurs after parameter validation but before matching. If the book changes between validation and matching, stale data could be used.

**Impact:**
- Potential for fills at outdated prices
- Limited by atomic seqno increments

**Recommendation:**
Consider moving seqno check to the very beginning of the function.

## Formal Verification Coverage

The project extensively uses Kani formal verification for:
- Crisis loss socialization (5 invariants)
- Deposit/withdraw safety (4 properties)
- Liquidation logic (13 properties)
- Order book operations
- LP operations

**Note:** Formal verification assumes correct implementation of verified functions. Integration bugs (like the vesting truncation) may bypass proofs.

## Recommendations

1. **Immediate Actions:**
   - Add slab registry validation in `execute_cross_slab`
   - Implement oracle staleness checks
   - Fix vesting calculation precision

2. **Security Audit:**
   - Conduct full security audit despite formal verification claims
   - Focus on integration points between verified and unverified code

3. **Testing:**
   - Add property-based tests for edge cases
   - Test with extreme values (very small/large amounts)

4. **Operational:**
   - Monitor oracle update frequency
   - Implement circuit breakers for extreme market conditions

## Conclusion

While the use of formal verification is commendable and covers many critical paths, several implementation vulnerabilities remain that could lead to fund loss or unfair treatment of users. The most critical issues involve access control bypasses and stale data usage. Immediate remediation of the slab whitelist and oracle staleness issues is recommended before mainnet deployment.</content>
</xai:function_call">VULNERABILITY_REPORT.md